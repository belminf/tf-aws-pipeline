---
AWSTemplateFormatVersion: 2010-09-09
Description: Terraform AWS pipeline
Parameters:
  RepoName:
    Type: String
    Description: Name for CodeCommitRepository
Resources:
  
  # CodeCommit repository
  Repository:
    Type: AWS::CodeCommit::Repository
    Properties:
      RepositoryName: !Ref RepoName
      RepositoryDescription: Terraform repository

  PipelineRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          Effect: Allow
          Principal:
            Service: codepipeline.amazonaws.com
          Action: sts:AssumeRole
      Path: /
      Policies:
        - PolicyName: codecommit-policy
          PolicyDocument:
            Statement:
              - Resource: "*"
                Effect: Allow
                Action:
                  - "codecommit:CancelUploadArchive"
                  - "codecommit:GetBranch"
                  - "codecommit:GetCommit"
                  - "codecommit:GetUploadArchiveStatus"
                  - "codecommit:UploadArchive"
                
  # CodePipeline
  ArtifactBucket:
    Type: AWS::S3::Bucket

Outputs:
  RepoSSHClone:
    Description: Repository SSH URL
    Value: !GetAtt Repository.CloneUrlSsh
